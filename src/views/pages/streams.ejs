<!DOCTYPE html>
<html lang="en">
    <head>
        <%- include('../partials/head'); %>
        <style>
            .clicked-link {
                background-color: gray !important;
            }
        </style>
    </head>
    <body class="container">
        <header><%- include('../partials/header'); %></header>

        <main>
            <div class="row">
                <div class="col-sm-12 py-2 d-flex">
                    <div class="p-2">
                        <label for="view_count_type">filter by view counts</label>
                        <select name="view_count_type">
                            <option value="">All</option>
                            <option value="odd">Odd</option>
                            <option value="even">Even</option>
                        </select>
                    </div>
                    <div class="p-2">
                        <label for="view_count_sort_order">Order by view counts</label>
                        <select name="view_count_sort_order">
                            <option value="">None</option>
                            <option value="ASC">Increase</option>
                            <option value="DESC">decrease</option>
                        </select>
                    </div>
                </div>
                <div class="col-sm-12 p-2">
                    <table style="min-height: 400px">
                        <thead>
                            <tr>
                                <th class="p-2">Stream Id</th>
                                <th class="p-2">User Name</th>
                                <th class="p-2">Game Name</th>
                                <th class="p-2">Title</th>
                                <th class="p-2">Viewer counts</th>
                            </tr>
                        </thead>
                        <tbody>
                            <%for (data of data) {%>
                            <tr>
                                <td class="p-2"><%=data.twitch_id%></td>
                                <td class="p-2"><%=data.user_name%></td>
                                <td class="p-2"><%=data.game_name%></td>
                                <td class="p-2"><%=data.title%></td>
                                <td class="p-2"><%=data.viewer_count%></td>
                            </tr>
                            <%}%>
                        </tbody>
                    </table>
                    <div class="d-flex justify-content-center p-2">
                        <nav aria-label="Page navigation">
                            <ul class="pagination">
                                <li class="page-item" id="page-first">
                                    <a class="page-link" href="#">First</a>
                                </li>
                                <li class="page-item" id="page-prev">
                                    <a class="page-link" href="#">Previous</a>
                                </li>
                                <%for(let index=first; index<=last; index++){%>
                                <li class="page-item item" value="<%=index%>">
                                    <a class="page-link item" href="#"><%=index+1%></a>
                                </li>
                                <%}%>
                                <li class="page-item" id="page-next">
                                    <a class="page-link" href="#">Next</a>
                                </li>
                                <li class="page-item" id="page-last">
                                    <a class="page-link" href="#">Last</a>
                                </li>
                            </ul>
                        </nav>
                        <div class="px-3 float-right">
                            <label for="per_page">Per Page</label>
                            <select name="per_page">
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer><%- include('../partials/footer'); %></footer>
        <script>
            window.onload = function () {
                const mainUrl = `<%=streamUrl%>`
                var per_page = parseInt("<%=per_page%>")
                var page = parseInt("<%=page%>")
                var total_page = parseInt("<%=per_page%>")
                var first = parseInt("<%=per_page%>")
                var last = parseInt("<%=per_page%>")
                document.querySelector('select[name="view_count_sort_order"]').value =
                    "<%=view_count_sort_order%>"
                document.querySelector('select[name="view_count_type"]').value =
                    "<%=view_count_type%>"
                document.querySelector('select[name="per_page"]').value = "<%=per_page%>"
                const setActiveItem = () => {
                    const selector = `li.item[value="${page}"] > a`
                    console.log(selector)
                    document.querySelector(selector).classList.add("clicked-link")
                }
                setActiveItem()
                const setUrl = () => {
                    const view_count_sort_order = document.querySelector(
                        'select[name="view_count_sort_order"]'
                    ).value
                    const view_count_type = document.querySelector(
                        'select[name="view_count_type"]'
                    ).value
                    const per_page = document.querySelector('select[name="per_page"]').value
                    const url = `${mainUrl}?view_count_sort_order=${view_count_sort_order}&view_count_type=${view_count_type}&per_page=${per_page}&page=${page}`
                    console.log("url======>", url)
                    window.location.href = url
                }
                document
                    .querySelector('select[name="view_count_sort_order"]')
                    .addEventListener("change", setUrl)
                document
                    .querySelector('select[name="view_count_type"]')
                    .addEventListener("change", setUrl)
                document.querySelector('select[name="per_page"]').addEventListener("change", setUrl)

                document.querySelector("#page-first").addEventListener("click", () => {
                    if (page === 0) return
                    page = 0
                    setUrl()
                })
                document.querySelector("#page-prev").addEventListener("click", () => {
                    page -= 1
                    if (page < 0) {
                        page = 0
                        return
                    }
                    setUrl()
                })
                document.querySelector("#page-next").addEventListener("click", () => {
                    page += 1
                    if (page > total_page) {
                        page = total_page
                        return
                    }
                    setUrl()
                })
                document.querySelector("#page-last").addEventListener("click", () => {
                    if (page === total_page) return
                    page = total_page
                    setUrl()
                })
                document.querySelectorAll("li.item").forEach((v) => {
                    v.addEventListener("click", (e) => {
                        let newPage = parseInt(v.value)
                        if (page !== newPage) {
                            page = newPage
                            setUrl()
                        }
                    })
                })
            }
        </script>
    </body>
</html>
